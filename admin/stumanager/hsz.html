<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<script src="../../js/global.js"></script>
	</head>
	<body>
		<div class="x-nav">
			<span class="layui-breadcrumb">
		        <a href="">首页</a>
		        <a href="">学生管理</a>
		        <a><cite>回收站</cite></a>
	        </span>
			<a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right" href="javascript:location.replace(location.href);" title="刷新">
				<i class="layui-icon" style="line-height:38px">&#xe669;</i>
			</a>
		</div>
		
		<!-- 条件查询区 -->
		<div class="layui-form-item" style="margin-left: 10px;">
			<form class="layui-form" action="">
				<label class="layui-form-mid">学生姓名：</label>
				<div class="layui-input-inline" style="width: 100px;">
					<input type="text" id="sname" placeholder="姓名关键字" autocomplete="off" class="layui-input">
				</div>
				<label class="layui-form-mid">年龄：</label>
				<div class="layui-input-inline" style="width: 80px;">
					<input type="number" id="sage" placeholder="年龄" autocomplete="off" class="layui-input">
				</div>
				<label class="layui-form-mid">性别：</label>
				<div class="layui-input-inline" style="width: 100px;">
					<select id="sgender">
						<option value="">--请选择--</option>
						<option value="男">男</option>
						<option value="女">女</option>
					</select>
				</div>
				<label class="layui-form-mid">手机号：</label>
				<div class="layui-input-inline" style="width: 120px;">
					<input type="number" id="sphone" placeholder="学生手机号" autocomplete="off" class="layui-input">
				</div>
				<label class="layui-form-mid">QQ号：</label>
				<div class="layui-input-inline" style="width: 120px;">
					<input type="number" id="sqq" placeholder="学生QQ号" autocomplete="off" class="layui-input">
				</div>
				<label class="layui-form-mid">是否缴费：</label>
				<div class="layui-input-inline" style="width: 100px;">
					<select id="paythefees">
						<option value="">--请选择--</option>
						<option value="是">是</option>
						<option value="否">否</option>
					</select>
				</div>
				<label class="layui-form-mid">是否回访：</label>
				<div class="layui-input-inline" style="width: 100px;">
					<select id="isvisit">
						<option value="">--请选择--</option>
						<option value="是">是</option>
						<option value="否">否</option>
					</select>
				</div>
				<button class="layui-btn" type="button" id="searsh">
			        <i class="layui-icon">&#xe615;</i>检索
			    </button>
			</form>
		</div>
		
		<!-- 查看 -->
		<div id="detailDiv" style="display: none; margin-top: 10px;">
			<form class="layui-form" id="detailForm" lay-filter="detailForm">
				<div class="layui-input-inline" style="margin-bottom: 212px;">
					<div class="layui-form-item" style="margin-left: 6px;">
						<label class="layui-form-mid">网络咨询师：</label>
						<div class="layui-input-inline" style="width: 490px;">
							<input type="text" name="loginname" id="sxname" disabled="disabled" placeholder="所属网络咨询师" autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-form-item" style="margin-left: 20px;">
						<label class="layui-form-mid">客户姓名：</label>
						<div class="layui-input-inline">
							<input type="text" name="sname" placeholder="客户姓名" autocomplete="off" class="layui-input">
						</div>
						<label class="layui-form-mid" style="margin-left: 20px;">客户年龄：</label>
						<div class="layui-input-inline">
							<input type="number" name="sage" placeholder="客户年龄" autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-form-item" style="margin-left: 33px;">
						<label class="layui-form-mid">手机号：</label>
						<div class="layui-input-inline">
							<input type="number" name="sphone" placeholder="客户手机号" autocomplete="off" class="layui-input">
						</div>
						<label class="layui-form-mid" style="margin-left: 20px;">来源渠道：</label>
						<div class="layui-input-inline">
							<input type="text" name="sourcechannel" placeholder="客户手机号" autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-form-item" style="margin-left: 48px;">
						<label class="layui-form-mid">性别：</label>
						<div class="layui-input-inline">
							<input type="radio" name="sgender" value="男" title="男" checked="">
							<input type="radio" name="sgender" value="女" title="女">
						</div>
						<label class="layui-form-mid" style="margin-left: 5px;">来源关键词：</label>
						<div class="layui-input-inline">
							<input type="text" name="sourceword" placeholder="来源关键词" autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-form-item" style="margin-left: 20px;">
						<label class="layui-form-mid">客户学历：</label>
						<div class="layui-input-inline">
							<input type="text" name="seducation" placeholder="来源关键词" autocomplete="off" class="layui-input">
						</div>
						<label class="layui-form-mid"  style="margin-left: 39px;">QQ号：</label>
						<div class="layui-input-inline">
							<input type="number" name="sqq" placeholder="客户QQ号" autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-form-item" style="margin-left: 20px;">
						<label class="layui-form-mid">客户状态：</label>
						<div class="layui-input-inline">
							<input type="text" name="sstatus" autocomplete="off" class="layui-input">
						</div>
						<label class="layui-form-mid" style="margin-left: 33px;">微信号：</label>
						<div class="layui-input-inline">
							<input type="text" name="wechatid" placeholder="客户微信号" autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-form-item" style="margin-left: 20px;">
						<label class="layui-form-mid">来源网址：</label>
						<div class="layui-input-inline">
							<input type="text" name="sourceurl" autocomplete="off" class="layui-input">
						</div>
						<label class="layui-form-mid" style="margin-left: 20px;">创建时间：</label>
						<div class="layui-input-inline">
							<input type="text" name="screatetime" placeholder="yyyy-MM-dd HH:mm:ss" autocomplete="off" class="layui-input">
						</div>
					</div> 
					<div class="layui-form-item" style="margin-left: 48px;">
						<label class="layui-form-mid">备注：</label>
						<div class="layui-input-inline" style="width: 490px;">
							<textarea name="sremark" placeholder="备注内容" autocomplete="off" class="layui-textarea"></textarea>
						</div>
					</div>
				</div>
				<div class="layui-input-inline">
					<div class="layui-form-item" style="margin-left: 6px;">
						<label class="layui-form-mid">所属咨询师：</label>
						<div class="layui-input-inline" style="width: 490px;">
							<input type="text" name="szxsid" disabled="disabled" placeholder="所属咨询师" autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-form-item" style="margin-left: 20px;">
						<label class="layui-form-mid">课程方向：</label>
						<div class="layui-input-inline">
							<input type="text" name="course" placeholder="课程方向" autocomplete="off" class="layui-input">
						</div>
						<label class="layui-form-mid" style="margin-left: 20px;">客户打分：</label>
						<div class="layui-input-inline">
							<input type="text" name="gradecase" placeholder="客户打分" autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-form-item" style="margin-left: 20px;">
						<label class="layui-form-mid">是否有效：</label>
						<div class="layui-input-inline">
							<input type="radio" name="iseffect" value="是" title="是">
							<input type="radio" name="iseffect" value="否" title="否">
						</div>
						<label class="layui-form-mid" style="margin-left: 20px;">无效原因：</label>
						<div class="layui-input-inline">
							<input type="text" name="invalidcause" placeholder="无效原因" autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-form-item" style="margin-left: 20px;">
						<label class="layui-form-mid">是否回访：</label>
						<div class="layui-input-inline">
							<input type="radio" name="isfirstvisit" value="是" title="是">
							<input type="radio" name="isfirstvisit" value="否" title="否">
						</div>
						<label class="layui-form-mid" style="margin-left: 20px;">首访时间：</label>
						<div class="layui-input-inline">
							<input type="text" name="firstvisittime" placeholder="yyyy-MM-dd HH:mm:ss" autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-form-item" style="margin-left: 20px;">
						<label class="layui-form-mid">是否上门：</label>
						<div class="layui-input-inline">
							<input type="radio" name="isvisit" value="是" title="是">
							<input type="radio" name="isvisit" value="否" title="否">
						</div>
						<label class="layui-form-mid"  style="margin-left: 20px;">上门时间：</label>
						<div class="layui-input-inline">
							<input type="text" name="visittime" placeholder="yyyy-MM-dd HH:mm:ss" autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-form-item" style="margin-left: 20px;">
						<label class="layui-form-mid">定金金额：</label>
						<div class="layui-input-inline">
							<input type="text" name="handselmoney" placeholder="定金金额" autocomplete="off" class="layui-input">
						</div>
						<label class="layui-form-mid" style="margin-left: 20px;">定金时间：</label>
						<div class="layui-input-inline">
							<input type="text" name="handsetime" placeholder="yyyy-MM-dd HH:mm:ss" autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-form-item" style="margin-left: 20px;">
						<label class="layui-form-mid">是否缴费：</label>
						<div class="layui-input-inline">
							<input type="radio" name="paythefees" value="是" title="是">
							<input type="radio" name="paythefees" value="否" title="否">
						</div>
						<label class="layui-form-mid" style="margin-left: 20px;">缴费时间：</label>
						<div class="layui-input-inline">
							<input type="text" name="paythefeestime" placeholder="yyyy-MM-dd HH:mm:ss" autocomplete="off" class="layui-input">
						</div>
					</div> 
					<div class="layui-form-item" style="margin-left: 20px;">
						<label class="layui-form-mid">缴费金额：</label>
						<div class="layui-input-inline" style="width: 490px;">
							<input type="text" name="paymentamount" placeholder="缴费金额" autocomplete="off" class="layui-input">
						</div>
					</div> 
					<div class="layui-form-item" style="margin-left: 20px;">
						<label class="layui-form-mid">是否退费：</label>
						<div class="layui-input-inline">
							<input type="radio" name="isoutpay" value="是" title="是">
							<input type="radio" name="isoutpay" value="否" title="否">
						</div>
						<label class="layui-form-mid" style="margin-left: 20px;">退费原因：</label>
						<div class="layui-input-inline">
							<input type="text" name="isoutpaycause" placeholder="退费原因" autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-form-item" style="margin-left: 20px;">
						<label class="layui-form-mid">退费时间：</label>
						<div class="layui-input-inline"  style="width: 490px;">
							<input type="text" name="isoutpaytime" placeholder="yyyy-MM-dd HH:mm:ss" autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-form-item" style="margin-left: 20px;">
						<label class="layui-form-mid">是否进班：</label>
						<div class="layui-input-inline">
							<input type="radio" name="intheclass" value="是" title="是">
							<input type="radio" name="intheclass" value="否" title="否">
						</div>
						<label class="layui-form-mid" style="margin-left: 20px;">进班时间：</label>
						<div class="layui-input-inline">
							<input type="text" name="intheclasstime" placeholder="yyyy-MM-dd HH:mm:ss" autocomplete="off" class="layui-input">
						</div>
					</div> 
					<div class="layui-form-item" style="margin-left: 20px;">
						<label class="layui-form-mid">进班备注：</label>
						<div class="layui-input-inline">
							<textarea name="intheclassremark" placeholder="进班备注" autocomplete="off" class="layui-textarea"></textarea>
						</div>
						<label class="layui-form-mid" style="margin-left: 5px;">咨询师备注：</label>
						<div class="layui-input-inline">
							<textarea name="rremark" placeholder="咨询师备注" autocomplete="off" class="layui-textarea"></textarea>
						</div>
					</div>
				</div>
			</form>
		</div>
		
		<!--数据表格头部工具栏-->
		<script type="text/html" id="toolbarDemo">
		    <div class="layui-btn-container">
			    <button class="layui-btn layui-btn-sm layui-btn-normal" lay-event="mildDelListStuBtn">
			    	<i class="layui-icon">&#xe672;</i>批量还原
			    </button>
			    <button class="layui-btn layui-btn-sm layui-btn-danger" lay-event="perpetualDelListStuBtn">
			    	<i class="layui-icon">&#xe640;</i>批量删除
			    </button>
		    </div>
		</script>
		
		<!--学生信息行内工具栏-->
		<script type="text/html" id="barDemo">
			<a class="layui-btn layui-btn-xs" lay-event="detail"><i class="layui-icon">&#xe60b;</i>查看</a>
			<a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="mildDel"><i class="layui-icon">&#xe672;</i>还原</a>
			<a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="perpetualDel"><i class="layui-icon">&#xe640;</i>删除</a>
		</script>
		
		<!--显示学生信息的数据表格-->
		<table id="demo" lay-filter="test"></table>
		
		<script>
			layui.use(['table', 'form', 'layer', 'laydate', 'element', 'upload'], function() {
				var table = layui.table;
				var form = layui.form;
				var layer = layui.layer;
				var laydate = layui.laydate;
				var upload = layui.upload;
				var $ = layui.$;
				
				var uphone =  globalData.getProtectmtel();	//存储手机号参数
				
				for (var i = 0; i < tempQuanXian.length; i++) {
					if (tempQuanXian[i] == "hsz:zxsjlgetAll") {	//判断有没有查看所有学生信息的权限
						uphone = "";	//如果有 取消手机号参数
					}
				}
				
				//渲染数据表格
				table.render({
					elem: '#demo',
					url: globalData.server + "/students/getAllstu",
					method: 'post',
					page: true,
					limit: '10',
					where: {
						'token': globalData.getToken(),
						'uphone': uphone,	//手机号参数 根据手机号查询属于该咨询师的学生
						'ifvalid': '否'	//只查询无效学生  被软删除了的
					}, //验证
					toolbar: '#toolbarDemo', //开启头部工具栏，并为其绑定左侧模板
					cols: [[
						{type: 'checkbox'},
						{type: 'numbers', title: '序号', align: 'center'},
						{field: 'sname', title: '学生姓名', width: 150, align: 'center'},
						{field: 'sage', title: '年龄', width: 60, align: 'center'},
						{field: 'sgender', title: '性别', width: 60, align: 'center'},
						{field: 'sphone', title: '手机号', width: 120, align: 'center'},
						{field: 'sstatus', title: '状态', width: 80, align: 'center'},
						{field: 'sourcechannel', title: '来源渠道', width: 150, align: 'center'},
						{field: 'sourceword', title: '来源关键字', width: 120, align: 'center'},
						{field: 'sqq', title: '客户qq', width: 120, align: 'center'},
						{field: 'wechatid', title: '微信', width: 150, align: 'center'},
						{field: 'screatetime', title: '创建时间', width: 160, align: 'center'},
						{title: '操作', align: 'center', width: 230, toolbar: '#barDemo'}
					]],
					id: "reloadId"
				});
				
				//头工具栏事件
			    table.on('toolbar(test)', function(obj){
				    switch(obj.event){
				        case 'mildDelListStuBtn':
					        var check = table.checkStatus("reloadId");	//获取数据表格
							var data = check.data;	//获取数据表格里面的数据
							var ids = [];	//创建数据，存储uid
							//遍历选中的数据
							for (var i = 0; i < data.length; i++) {
								ids.push(data[i].sid);	//取出uid并添加到数组中
							}
							var idJoin = ids.join(",");  //使用逗号分隔uid
							if (ids == null || ids == "") {	//判断是否勾选了数据
								layer.msg("请先选择要还原的数据", {icon : 5});	//没选择给出提示
								return false;	//结束方法
							}
							layer.confirm("确认还原这["+ ids.length +"]条数据吗？", function(){
								var delUrl = globalData.server + "/students/mildDel";	//请求地址
								//请求参数
								var strData = {
									"sid": idJoin,
									"ifvalid": "是",
									"token": globalData.getToken()
								}
								//post请求
								$.post(delUrl, strData, function(res){
									if (res > 0) {
										layer.msg("还原成功!", {icon : 1});
										active.reload();
									} else{
										layer.msg("还原失败!", {icon : 5});
									}					
								}, "json");
							});
				        	break;
				        case 'perpetualDelListStuBtn':
				        	var check = table.checkStatus("reloadId");	//获取数据表格
							var data = check.data;	//获取数据表格里面的数据
							var ids = [];	//创建数据，存储uid
							//遍历选中的数据
							for (var i = 0; i < data.length; i++) {
								ids.push(data[i].sid);	//取出uid并添加到数组中
							}
							var idJoin = ids.join(",");  //使用逗号分隔uid
							if (ids == null || ids == "") {	//判断是否勾选了数据
								layer.msg("请先选择要删除的数据", {icon : 5});	//没选择给出提示
								return false;	//结束方法
							}
							layer.confirm("这将会永久删除这["+ ids.length +"]条数据", function(){
								var delUrl = globalData.server + "/students/perpetuaDel";	//请求地址
								//请求参数
								var strData = {
									"sid": idJoin,
									"token": globalData.getToken()
								}
								//post请求
								$.post(delUrl, strData, function(res){
									if (res > 0) {
										layer.msg("删除成功!", {icon : 1});
										active.reload();
									} else{
										layer.msg("删除失败!", {icon : 5});
									}					
								}, "json");
							});
				        	break;
				      	case 'LAYTABLE_TIPS':	//自定义头工具栏右侧图标 - 提示
				        	layer.alert('这是工具栏右侧自定义的一个图标按钮');
				      		break;
				    };
			    });
				
				//监听工具条 
				table.on('tool(test)', function(obj) { //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
					var data = obj.data; //获得当前行数据
					var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
					var tr = obj.tr; //获得当前行 tr 的 DOM 对象（如果有的话）
					var uid = data.uid; //获得当前点击的uid
					//根据uid 查询姓名
					var editUrl = globalData.server + "/users/findByUid"; //请求地址
					var strData = {
						"uid": uid,
						"token": globalData.getToken()
					}
					$.post(editUrl, strData, function(res) {
						$("#sxname").val(res.loginname);
					}, "json");
					if(layEvent === 'detail') { //查看
						form.val("detailForm", data); //数据回显
						layer.open({
							type: 1,
							title: "您正在查看[" + data.sname + "]客户的信息",
							anim: 1,
							maxmin: true,
							offset: '1px',
							area: ['1280px', '730px'],
							content: $('#detailDiv'),
							cancel: function(index, layero){ 	//弹窗关闭时的回调函数
							    layer.msg("已关闭", {icon : 6});	//提示已关闭
							    layer.close(index);	//关闭弹出层
							  	return false; 
							}  
						});
					} else if(layEvent === 'mildDel'){ //学生信息还原（还原数据）
						layer.confirm("确认要还原[" + data.sname + "]吗？", function(){
							var delUrl = globalData.server + "/students/mildDel";	//请求地址
							//请求参数
							var strData = {
								"sid": data.sid,
								"ifvalid": "是",
								"token": globalData.getToken()
							}
							//post请求
							$.post(delUrl, strData, function(res){
								if (res > 0) {
									layer.msg("还原成功!", {icon : 1});
									active.reload();
								} else{
									layer.msg("还原失败!", {icon : 5});
								}					
							}, "json");
						});
					} else if(layEvent === 'perpetualDel'){ //学生信息删除（真删除）
						layer.confirm("这将会永久删除[" + data.sname + "]的信息", function(){
							var delUrl = globalData.server + "/students/perpetuaDel";	//请求地址
							//请求参数
							var strData = {
								"sid": data.sid,
								"token": globalData.getToken()
							}
							//post请求
							$.post(delUrl, strData, function(res){
								if (res > 0) {
									layer.msg("删除成功!", {icon : 1});
									active.reload();
								} else{
									layer.msg("删除失败!", {icon : 5});
								}					
							}, "json");
						});
					}
				});
				
				//点击学生信息检索按钮时触发
				$("#searsh").on("click", function() {
					active.reload();
					return false;
				});

				/**
				 * 重载学生数据表格的方法
				 * 参数 sname sage sphone sqq sgender paythefees isvisit
				 */
				active = {
					reload: function() {
						table.reload("reloadId", {
							where: {
								"sname": $("#sname").val(),
								"sage": $("#sage").val(),
								"sphone": $("#sphone").val(),
								"sqq": $("#sqq").val(),
								"sgender": $("#sgender").val(),
								"paythefees": $("#paythefees").val(),
								"isvisit": $("#isvisit").val(),
								"token": globalData.getToken()
							},
							page: {
								curr: 1
							}
						});
					}
				}
				
			//layui.use的括号
			});
		</script>
	</body>

</html>