<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<script src="../../js/global.js" type="text/javascript" charset="utf-8"></script>
	</head>
	<body>
		<a href="xsxx.html" style="cursor: pointer; margin-top:3px; margin-left: 10px;" title="返回我的学生页面">
			<i class="layui-icon" style="line-height:38px; font-size: 20px;">&#xe65c;</i>
			<span style="line-height:38px; font-size: 20px;">
				返回
			</span>
		</a>
		<a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right" href="javascript:location.replace(location.href);" title="刷新">
			<i class="layui-icon" style="line-height:38px">&#xe669;</i>
		</a>
		<div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">
			<ul class="layui-tab-title">
				<li class="layui-this">未读消息</li>
				<li>已读消息</li>
			</ul>
			<div class="layui-tab-content" style="height: 100px;">
				<div class="layui-tab-item layui-show">
					<fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
						<legend>消息</legend>
					</fieldset>
					<div id="test9" class="demo-tree demo-tree-box" style="width: 1200px; height: 550px; overflow: scroll;">
						<ul class="layui-timeline" id="msgUrl">
							
						</ul>
					</div>
				</div>
				<div class="layui-tab-item">
					<fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
						<legend>历史消息</legend>
					</fieldset>
					<div id="test9" class="demo-tree demo-tree-box" style="width: 1200px; height: 550px; overflow: scroll;">
						<ul class="layui-timeline" id="readMsgUrl">
							
						</ul>
					</div>
				</div>
			</div>
		</div>

		<script type="text/javascript">
			layui.use(['table', 'form', 'layer', 'element'], function() {
				var table = layui.table;
				var form = layui.form;
				var layer = layui.layer;
				var element = layui.element;
				var $ = layui.$;

				/**
				 * 页面加载初始化查询  查询当前登录的咨询师有多少条未读的动态推送消息
				 */
				$.post(globalData.server + "/dynamicmessage/getMsgByUid", {
					"uid": globalData.getUid(),
					"isread": '未读',
					'token': globalData.getToken()
				}, function(res) {
					for(var i = 0; i < res.length; i++) {
						var e = "<li class='layui-timeline-item'>";
						e += "<i class='layui-icon layui-timeline-axis'>&#xe60e;</i>";
						e += "<div class='layui-timeline-content layui-text'>";
						e += "<h3 class='layui-timeline-title'>"+ res[i].dcreatetime +"</h3>";
						e += "<p>";
						e += "<span>" + res[i].user.loginname + "<span>";
						e += "<span>：学生[" + res[i].sname + "]<span>";
						e += "<span>，" + res[i].dcontent + "</span>";
						e += "<span style='margin-left: 100px; cursor: pointer; color: green;' onclick='isRead(\""+res[i].did+"\")'>";
						e += "<i class='layui-icon'>&#xe642;</i>标记为已读";
						e += "</span>"
						e += "</p>";
						e += "</div>";
						e += "</li>";
						$("#msgUrl").append(e);
					}
				}, "json");
				
				/**
				 * 页面加载时触发，获取当前登录的咨询师的历史消息
				 */
				$.post(globalData.server + "/dynamicmessage/getMsgByUid", {
					"uid": globalData.getUid(),
					"isread": "已读",
					"token": globalData.getToken()
				}, function(res){
					for(var i = 0; i < res.length; i++) {
						var e = "<li class='layui-timeline-item'>";
						e += "<i class='layui-icon layui-timeline-axis'>&#xe60e;</i>";
						e += "<div class='layui-timeline-content layui-text'>";
						e += "<h3 class='layui-timeline-title'>"+ res[i].dcreatetime +"</h3>";
						e += "<p>";
						e += "<span>" + res[i].user.loginname + "<span>";
						e += "<span>：学生[" + res[i].sname + "]<span>";
						e += "<span>，" + res[i].dcontent + "</span>";
						e += "</p>";
						e += "</div>";
						e += "</li>";
						$("#readMsgUrl").append(e);
					}
				}, "json");
				
				
			//layui.use的括号
			});
			
			/**
			 * 将消息标注为已读的方法
			 * @param did
			 */
			function isRead(did){
				$.post(globalData.server + "/dynamicmessage/edit", {
					"did": did,
					"isread": "已读",
					"token": globalData.getToken()
				}, function(res){
					if (res > 0) {
						setTimeout(function() {
							window.location.href="javascript:location.replace(location.href);";
						}, 500);
					}
				}, "json");
			}
			
		</script>

	</body>
</html>